–û—Ç–ª–∏—á–Ω—ã–π –ø–ª–∞–Ω! –í–æ—Ç –≥–æ—Ç–æ–≤—ã–µ –∞–≤—Ç–æ—Ç–µ—Å—Ç—ã –Ω–∞ Python –¥–ª—è –≤–∞—à–µ–π —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —Ñ–∏–ª–∏–∞–ª–∞–º–∏:

[DeepSeek - Into the Unknown](https://chat.deepseek.com/a/chat/s/23cdec35-eff3-4e26-998e-7988eb3efee7)

## 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

bash

pip install psycopg2 pytest pytest-html

## 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ (config.py)

python

import psycopg2
from dataclasses import dataclass

@dataclass
class DBConfig:
    host: str = "localhost"
    port: int = 5432
    user: str = "postgres"
    password: str = "your_password"
    
    db_filial1: str = "filial1"
    db_filial2: str = "filial2"

class DatabaseManager:
    def __init__(self, config: DBConfig):
        self.config = config
    
    def get_connection(self, database: str):
        return psycopg2.connect(
            host=self.config.host,
            port=self.config.port,
            user=self.config.user,
            password=self.config.password,
            database=database
        )
    
    def execute_query(self, database: str, query: str, params=None, fetch=False):
        conn = self.get_connection(database)
        try:
            with conn.cursor() as cursor:
                cursor.execute(query, params)
                if fetch:
                    return cursor.fetchall()
                conn.commit()
                return cursor.rowcount
        finally:
            conn.close()

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
config = DBConfig()
db_manager = DatabaseManager(config)

## 3. –ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (test_base.py)

python

import pytest
from config import db_manager, config

class BaseSyncTest:
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    
    def setup_method(self):
        """–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º"""
        self.clean_test_data()
    
    def clean_test_data(self):
        """–û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–µ–∏—Ö –±–∞–∑–∞—Ö"""
        clean_queries = [
            "DELETE FROM Conflist",
            "DELETE FROM EmplHistory",
            "DELETE FROM Employee WHERE EmplCode >= 1000",
            "DELETE FROM Positions WHERE PosCode >= 100"
        ]
        
        for db in [config.db_filial1, config.db_filial2]:
            for query in clean_queries:
                try:
                    db_manager.execute_query(db, query)
                except Exception as e:
                    print(f"Warning: {e}")
    
    def make_snapshot(self, database: str):
        """–°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∏–º–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
        query = "SELECT * FROM make_data_snapshot()"
        return db_manager.execute_query(database, query, fetch=True)
    
    def get_employee_count(self, database: str, filial: int = None):
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"""
        if filial:
            query = "SELECT COUNT(*) FROM Employee WHERE Filial = %s"
            return db_manager.execute_query(database, query, (filial,), fetch=True)[0][0]
        else:
            query = "SELECT COUNT(*) FROM Employee"
            return db_manager.execute_query(database, query, fetch=True)[0][0]
    
    def get_conflict_count(self, database: str):
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤"""
        query = "SELECT COUNT(*) FROM Conflist"
        return db_manager.execute_query(database, query, fetch=True)[0][0]
    
    def add_employee(self, database: str, employee_data: dict):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"""
        query = """
        INSERT INTO Employee (EmplCode, Name, Surname, Patronymic, Birthday, Passport, PosCode, Filial)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
        """
        return db_manager.execute_query(database, query, tuple(employee_data.values()))
    
    def add_position(self, database: str, position_data: dict):
        """–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–∂–Ω–æ—Å—Ç—å"""
        query = """
        INSERT INTO Positions (PosCode, PosName, ParentPos, Filial)
        VALUES (%s, %s, %s, %s)
        """
        return db_manager.execute_query(database, query, tuple(position_data.values()))
    
    def add_employment_history(self, database: str, history_data: dict):
        """–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        query = """
        INSERT INTO EmplHistory (EmplCode, ChangeDate, Surname, Passport, PosCode, Action)
        VALUES (%s, %s, %s, %s, %s, %s)
        """
        return db_manager.execute_query(database, query, tuple(history_data.values()))

## 4. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ—Å—Ç—ã (test_sync_scenarios.py)

python

import pytest
from datetime import date, datetime
from test_base import BaseSyncTest

class TestSyncScenarios(BaseSyncTest):
    """–¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    
    def test_01_sync_new_employee_from_filial1(self):
        """–¢–µ—Å—Ç 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –§1 –≤ –§2"""
        print("\n=== –¢–µ—Å—Ç 1: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏–∑ –§1 –≤ –§2 ===")
        
        # –®–ê–ì 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
        initial_count_f2 = self.get_employee_count(config.db_filial2, filial=2)
        print(f"–ù–∞—á–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –§2: {initial_count_f2}")
        
        # –®–ê–ì 2: –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ –§1
        new_employee = {
            'EmplCode': 1003,
            'Name': '–°–µ—Ä–≥–µ–π',
            'Surname': '–ö–æ–∑–ª–æ–≤', 
            'Patronymic': '–ê–ª–µ–∫—Å–µ–µ–≤–∏—á',
            'Birthday': date(1990, 5, 5),
            'Passport': '4444444444',
            'PosCode': 2,
            'Filial': 1
        }
        
        self.add_employee(config.db_filial1, new_employee)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏—é
        history_data = {
            'EmplCode': 1003,
            'ChangeDate': date.today(),
            'Surname': '–ö–æ–∑–ª–æ–≤',
            'Passport': '4444444444', 
            'PosCode': 2,
            'Action': 'Hired'
        }
        self.add_employment_history(config.db_filial1, history_data)
        
        print("–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤ –§1")
        
        # –®–ê–ì 3: –≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç job)
        self.emulate_sync()
        
        # –®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        final_count_f2 = self.get_employee_count(config.db_filial2, filial=2)
        conflict_count = self.get_conflict_count(config.db_filial2)
        
        print(f"–ö–æ–Ω–µ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –§2: {final_count_f2}")
        print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: {conflict_count}")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∏
        assert final_count_f2 == initial_count_f2 + 1, "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –§2 –¥–æ–ª–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å—Å—è –Ω–∞ 1"
        assert conflict_count == 0, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–æ—è–≤–∏–ª—Å—è –≤ –§2
        employee_in_f2 = self.get_employee_by_code(config.db_filial2, 1003)
        assert employee_in_f2 is not None, "–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –§2"
        assert employee_in_f2[2] == '–ö–æ–∑–ª–æ–≤', "–§–∞–º–∏–ª–∏—è –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å"
    
    def test_02_employee_duplication_full_match(self):
        """–¢–µ—Å—Ç 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"""
        print("\n=== –¢–µ—Å—Ç 2: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–ª–Ω–æ–≥–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ ===")
        
        # –®–ê–ì 1: –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ –æ–±–∞ —Ñ–∏–ª–∏–∞–ª–∞
        employee_data = {
            'EmplCode': 1004,
            'Name': '–ê–ª–µ–∫—Å–µ–π',
            'Surname': '–ü–µ—Ç—Ä–æ–≤',
            'Patronymic': '–°–µ—Ä–≥–µ–µ–≤–∏—á', 
            'Birthday': date(1985, 10, 15),
            'Passport': '5555555555',
            'PosCode': 1,
            'Filial': 1
        }
        
        self.add_employee(config.db_filial1, employee_data)
        
        employee_data['Filial'] = 2
        self.add_employee(config.db_filial2, employee_data)
        
        print("–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ –≤ –æ–±–∞ —Ñ–∏–ª–∏–∞–ª–∞")
        
        # –®–ê–ì 2: –≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        self.emulate_sync()
        
        # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
        duplicate_count = self.check_duplicate_employees()
        conflict_count = self.get_conflict_count(config.db_filial1)
        
        print(f"–ù–∞–π–¥–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {duplicate_count}")
        print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤: {conflict_count}")
        
        assert duplicate_count == 0, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤"
        assert conflict_count == 0, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –ø–æ–ª–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏"
    
    def test_03_partial_match_conflict(self):
        """–¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏"""
        print("\n=== –¢–µ—Å—Ç 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏ ===")
        
        # –®–ê–ì 1: –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º
        employee_f1 = {
            'EmplCode': 1005,
            'Name': '–î–º–∏—Ç—Ä–∏–π',
            'Surname': '–°–º–∏—Ä–Ω–æ–≤',
            'Patronymic': '–í–∏–∫—Ç–æ—Ä–æ–≤–∏—á',
            'Birthday': date(1988, 3, 20),
            'Passport': '6666666666', 
            'PosCode': 2,
            'Filial': 1
        }
        
        employee_f2 = {
            'EmplCode': 2005, 
            'Name': '–î–º–∏—Ç—Ä–∏–π',
            'Surname': '–°–º–∏—Ä–Ω–æ–≤', 
            'Patronymic': '–í–∏–∫—Ç–æ—Ä–æ–≤–∏—á',
            'Birthday': date(1988, 3, 20),  # –°–æ–≤–ø–∞–¥–∞—é—Ç –§–ò–û –∏ –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è
            'Passport': '7777777777',       # –ù–æ —Ä–∞–∑–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç!
            'PosCode': 3,
            'Filial': 2
        }
        
        self.add_employee(config.db_filial1, employee_f1)
        self.add_employee(config.db_filial2, employee_f2)
        
        print("–î–æ–±–∞–≤–ª–µ–Ω—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏ —Å —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º (—Ä–∞–∑–Ω—ã–µ –ø–∞—Å–ø–æ—Ä—Ç–∞)")
        
        # –®–ê–ì 2: –≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        self.emulate_sync()
        
        # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞
        conflict_count_f1 = self.get_conflict_count(config.db_filial1)
        conflict_count_f2 = self.get_conflict_count(config.db_filial2)
        
        print(f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –§1: {conflict_count_f1}")
        print(f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤ –§2: {conflict_count_f2}")
        
        assert conflict_count_f1 > 0 or conflict_count_f2 > 0, "–î–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
        employee1 = self.get_employee_by_code(config.db_filial1, 1005)
        employee2 = self.get_employee_by_code(config.db_filial2, 2005)
        
        assert employee1[5] == '6666666666', "–ü–∞—Å–ø–æ—Ä—Ç –≤ –§1 –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è"
        assert employee2[5] == '7777777777', "–ü–∞—Å–ø–æ—Ä—Ç –≤ –§2 –Ω–µ –¥–æ–ª–∂–µ–Ω –∏–∑–º–µ–Ω–∏—Ç—å—Å—è"
    
    def test_04_employment_history_sync(self):
        """–¢–µ—Å—Ç 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"""
        print("\n=== –¢–µ—Å—Ç 4: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä—É–¥–æ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ===")
        
        # –®–ê–ì 1: –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –∏—Å—Ç–æ—Ä–∏—é –≤ –§1
        employee_data = {
            'EmplCode': 1006,
            'Name': '–û–ª—å–≥–∞',
            'Surname': '–ò–≤–∞–Ω–æ–≤–∞',
            'Patronymic': '–ü–µ—Ç—Ä–æ–≤–Ω–∞',
            'Birthday': date(1992, 7, 12),
            'Passport': '8888888888',
            'PosCode': 4,
            'Filial': 1
        }
        self.add_employee(config.db_filial1, employee_data)
        
        history_data = {
            'EmplCode': 1006,
            'ChangeDate': date.today(),
            'Surname': '–ò–≤–∞–Ω–æ–≤–∞',
            'Passport': '8888888888',
            'PosCode': 4, 
            'Action': 'Hired'
        }
        self.add_employment_history(config.db_filial1, history_data)
        
        initial_history_count = self.get_history_count(config.db_filial2, 1006)
        
        # –®–ê–ì 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        self.emulate_sync()
        
        # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏
        final_history_count = self.get_history_count(config.db_filial2, 1006)
        
        print(f"–ò—Å—Ç–æ—Ä–∏—è –¥–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {initial_history_count}")
        print(f"–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {final_history_count}")
        
        assert final_history_count == initial_history_count + 1, "–ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è"
    
    def test_05_conflict_resolution(self):
        """–¢–µ—Å—Ç 5: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞"""
        print("\n=== –¢–µ—Å—Ç 5: –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ===")
        
        # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é
        self.test_03_partial_match_conflict()
        
        # –®–ê–ì 1: –†–∞–∑—Ä–µ—à–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç (–æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –§2)
        update_query = """
        UPDATE Employee 
        SET Passport = '6666666666'
        WHERE EmplCode = 2005
        """
        db_manager.execute_query(config.db_filial2, update_query)
        
        # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
        db_manager.execute_query(config.db_filial1, "DELETE FROM Conflist")
        db_manager.execute_query(config.db_filial2, "DELETE FROM Conflist")
        
        print("–ö–æ–Ω—Ñ–ª–∏–∫—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –≤—Ä—É—á–Ω—É—é")
        
        # –®–ê–ì 2: –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
        self.emulate_sync()
        
        # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞
        conflict_count = self.get_conflict_count(config.db_filial1)
        duplicate_count = self.check_duplicate_employees()
        
        print(f"–ö–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: {conflict_count}")
        print(f"–î—É–±–ª–∏–∫–∞—Ç–æ–≤ –ø–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: {duplicate_count}")
        
        assert conflict_count == 0, "–ü–æ—Å–ª–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤"
        assert duplicate_count == 0, "–ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤"
    
    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    def emulate_sync(self):
        """–≠–º—É–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
        # –í —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ –≤–∞—à–µ–≥–æ job —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        # –î–ª—è —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—Å—Ç–æ –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É
        import time
        time.sleep(1)
        print("–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
    
    def get_employee_by_code(self, database: str, empl_code: int):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ –∫–æ–¥—É"""
        query = "SELECT * FROM Employee WHERE EmplCode = %s"
        result = db_manager.execute_query(database, query, (empl_code,), fetch=True)
        return result[0] if result else None
    
    def get_history_count(self, database: str, empl_code: int):
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞"""
        query = "SELECT COUNT(*) FROM EmplHistory WHERE EmplCode = %s"
        return db_manager.execute_query(database, query, (empl_code,), fetch=True)[0][0]
    
    def check_duplicate_employees(self):
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"""
        query = """
        SELECT COUNT(*) FROM (
            SELECT Surname, Name, Patronymic, Birthday, Passport, COUNT(*)
            FROM Employee
            GROUP BY Surname, Name, Patronymic, Birthday, Passport
            HAVING COUNT(*) > 1
        ) AS duplicates
        """
        result1 = db_manager.execute_query(config.db_filial1, query, fetch=True)[0][0]
        result2 = db_manager.execute_query(config.db_filial2, query, fetch=True)[0][0]
        return result1 + result2

## 5. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ (run_tests.py)

python

import pytest
import subprocess
import sys
from datetime import datetime

def run_tests():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤ —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á–µ—Ç–∞"""
    print("=== –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ===")
    print(f"–í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: {datetime.now()}")
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã pytest
    pytest_args = [
        "test_sync_scenarios.py",
        "-v",  # –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥
        "--html=test_report.html",  # HTML –æ—Ç—á–µ—Ç
        "--self-contained-html",
        "--capture=sys"  # –î–ª—è –≤—ã–≤–æ–¥–∞ print
    ]
    
    # –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    exit_code = pytest.main(pytest_args)
    
    if exit_code == 0:
        print("\n‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!")
    else:
        print(f"\n‚ùå –ß–∞—Å—Ç—å —Ç–µ—Å—Ç–æ–≤ –Ω–µ –ø—Ä–æ—à–ª–∞. –ö–æ–¥ –≤—ã—Ö–æ–¥–∞: {exit_code}")
    
    print(f"\n–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: test_report.html")
    return exit_code

if __name__ == "__main__":
    result = run_tests()
    sys.exit(result)

## 6. –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î (db_utils.py)

python

from config import db_manager, config

def initialize_test_data():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–µ–∏—Ö –±–∞–∑–∞—Ö"""
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    cleanup_queries = [
        "DELETE FROM Conflist",
        "DELETE FROM EmplHistory", 
        "DELETE FROM Employee",
        "DELETE FROM Positions"
    ]
    
    for db in [config.db_filial1, config.db_filial2]:
        for query in cleanup_queries:
            try:
                db_manager.execute_query(db, query)
            except Exception as e:
                print(f"Warning during cleanup: {e}")
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–æ–ª–∂–Ω–æ—Å—Ç–µ–π
    positions = [
        (1, '–ú–µ–Ω–µ–¥–∂–µ—Ä', None, 1),
        (2, '–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫', None, 1),
        (3, '–ê–Ω–∞–ª–∏—Ç–∏–∫', None, 2),
        (4, '–î–∏–∑–∞–π–Ω–µ—Ä', None, 2)
    ]
    
    for db in [config.db_filial1, config.db_filial2]:
        for pos in positions:
            query = "INSERT INTO Positions (PosCode, PosName, ParentPos, Filial) VALUES (%s, %s, %s, %s)"
            db_manager.execute_query(db, query, pos)
    
    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
    employees_f1 = [
        (1001, '–ò–≤–∞–Ω', '–ò–≤–∞–Ω–æ–≤', '–ò–≤–∞–Ω–æ–≤–∏—á', '1990-01-01', '1234567890', 1, 1),
        (1002, '–ü–µ—Ç—Ä', '–ü–µ—Ç—Ä–æ–≤', '–ü–µ—Ç—Ä–æ–≤–∏—á', '1991-02-02', '1111111111', 2, 1)
    ]
    
    employees_f2 = [
        (2001, '–ú–∞—Ä–∏—è', '–°–∏–¥–æ—Ä–æ–≤–∞', '–ò–≤–∞–Ω–æ–≤–Ω–∞', '1992-03-03', '2222222222', 3, 2),
        (2002, '–ê–Ω–Ω–∞', '–°–º–∏—Ä–Ω–æ–≤–∞', '–ü–µ—Ç—Ä–æ–≤–Ω–∞', '1993-04-04', '3333333333', 4, 2)
    ]
    
    for emp in employees_f1:
        query = """
        INSERT INTO Employee (EmplCode, Name, Surname, Patronymic, Birthday, Passport, PosCode, Filial)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
        """
        db_manager.execute_query(config.db_filial1, query, emp)
    
    for emp in employees_f2:
        query = """
        INSERT INTO Employee (EmplCode, Name, Surname, Patronymic, Birthday, Passport, PosCode, Filial)
        VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
        """
        db_manager.execute_query(config.db_filial2, query, emp)
    
    print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ –æ–±–µ–∏—Ö –±–∞–∑–∞—Ö")

def check_database_health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö"""
    print("\n=== –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö ===")
    
    for db_name in [config.db_filial1, config.db_filial2]:
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            conn = db_manager.get_connection(db_name)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            tables = ['Employee', 'Positions', 'EmplHistory', 'Conflist']
            for table in tables:
                query = f"SELECT COUNT(*) FROM {table}"
                count = db_manager.execute_query(db_name, query, fetch=True)[0][0]
                print(f"üìä {db_name}.{table}: {count} –∑–∞–ø–∏—Å–µ–π")
            
            conn.close()
            print(f"‚úÖ –ë–∞–∑–∞ {db_name} –≤ –ø–æ—Ä—è–¥–∫–µ")
            
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ {db_name}: {e}")

if __name__ == "__main__":
    initialize_test_data()
    check_database_health()

## 7. –ó–∞–ø—É—Å–∫

bash

# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
python db_utils.py

# 2. –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
python run_tests.py

# 3. –ò–ª–∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ pytest –Ω–∞–ø—Ä—è–º—É—é
pytest test_sync_scenarios.py -v

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏:

1. **–ò–∑–æ–ª—è—Ü–∏—è —Ç–µ—Å—Ç–æ–≤**¬†- –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å —á–∏—Å—Ç—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    
2. **–ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**¬†- –≤—Å–µ —à–∞–≥–∏ —Ç–µ—Å—Ç–∞ –≤—ã–≤–æ–¥—è—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
    
3. **HTML –æ—Ç—á–µ—Ç**¬†- –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    
4. **–ì–∏–±–∫–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**¬†- –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    
5. **–≠–º—É–ª—è—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**¬†- –≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤—ã–∑–æ–≤ –≤–∞—à–µ–≥–æ ETL-–ø—Ä–æ—Ü–µ—Å—Å–∞
    

–¢–µ—Å—Ç—ã –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏–∑ –≤–∞—à–µ–≥–æ –ø–ª–∞–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!